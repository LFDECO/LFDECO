name: Update LeetCode Feed

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Profile Repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Latest LeetCode Solves (Clean)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "<ul>" > lc_feed.txt

          COMMITS=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "User-Agent: github-actions" \
            "https://api.github.com/repos/LFDECO/Leetcode-solutions/commits?per_page=10")

          echo "$COMMITS" | jq -r '.[].sha' | while read sha; do

            curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "User-Agent: github-actions" \
              "https://api.github.com/repos/LFDECO/Leetcode-solutions/commits/$sha" \
            | jq -r '.files[].filename' \
            | while read file; do

                PROBLEM=$(echo "$file" | cut -d'/' -f1)

                # ignore root files like README.md, stats.json
                if [[ "$PROBLEM" == *".md" ]] || [[ "$PROBLEM" == *".json" ]]; then
                  continue
                fi

                # only allow real LeetCode folder format like 0184-department-highest-salary
                if [[ ! "$PROBLEM" =~ ^[0-9]{4}- ]]; then
                  continue
                fi

                # avoid duplicates
                if ! grep -q "$PROBLEM" lc_feed.txt; then
                  echo "<li><a href=\"https://github.com/LFDECO/Leetcode-solutions/tree/main/$PROBLEM\"><b>$PROBLEM</b></a></li>" >> lc_feed.txt
                fi

            done
          done

          echo "</ul>" >> lc_feed.txt

      - name: Inject into README
        run: |
          awk '
          BEGIN {found=0}
          /<!-- LEETCODE_SOLVES:START -->/ {print; system("cat lc_feed.txt"); found=1; next}
          /<!-- LEETCODE_SOLVES:END -->/ {print; found=0; next}
          !found {print}
          ' README.md > README_NEW.md

          mv README_NEW.md README.md

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Updated LeetCode feed" || exit 0
          git push

